<template>
  <v-card height="580px" class="ma-4 my-5" :loading="this.loading">
    <v-card-title v-text="title"></v-card-title>
    <v-row no-gutters justify="center">
      <v-col>
        <v-list
            tile
            dense
            min-height="460"
            max-height="1000"
        >
          <v-divider></v-divider>
          <v-list-item-group>
            <template v-for="(item, index) in posts">
              <v-list-item :key="item.postId">
                  <v-list-item-avatar>
                    <v-chip
                        color="#E6E6FA"
                        label
                        small
                    >
                      {{item.commentCount}}
                    </v-chip>
                  </v-list-item-avatar>
                  <v-list-item-content @click="stepToPost(item.postId)">
                    <template >
                    <v-list-item-title v-text="item.title"></v-list-item-title>
                    <v-list-item-subtitle v-text="item.sectionName"></v-list-item-subtitle>
                    </template>
                  </v-list-item-content>
                  <v-list-item-action>
                      <v-list-item-action-text v-text="item.updateTime"></v-list-item-action-text>
                  </v-list-item-action>
                  <v-list-item-action>
                    <v-btn icon @click="deletePost(item.postId)">
                      <v-icon>mdi-delete-outline</v-icon>
                    </v-btn>
                  </v-list-item-action>
              </v-list-item>
              <v-divider
                  :key="index"
              ></v-divider>
            </template>
          </v-list-item-group>
        </v-list>
        <v-row v-if="this.total > perPage">
          <v-col cols="8">
            <v-pagination
                circle
                class="left"
                color="#6A5ACD"
                v-if="Math.ceil(total / perPage) > 1"
                v-model="page"
                :length="Math.ceil(total/ perPage)"
                :total-visible="10"
                @input="onPageChange(page)"
            ></v-pagination>
          </v-col>
          <v-col cols="4">
            <v-row no-gutters>
              <span class="lead">跳转至第</span>
              <v-text-field class="shrink" color="#7d73be" solo dense v-model="whichPage" ></v-text-field>
              <span class="lead">页</span>
              <v-btn class="goBtn" small fab @click="jumpPage()">GO</v-btn>
            </v-row>
          </v-col>
        </v-row>
      </v-col>
    </v-row>
    <DeletePost
        :showConfirm="this.showConfirm"
        :postId="this.postId"
        @close="closeConfirm"
        @submit="submit"
    >
    </DeletePost>
  </v-card>
</template>

<script>
import {getMyPost} from "@/api/account";
import DeletePost from "@/views/home/account/components/DeletePost";

export default {
  name: "AccountPost",
  components: {DeletePost},
  data(){
    return {
      title:"我的帖子",
      loading: false,
      postId:0,
      control:false,
      showConfirm:false,
      valid: true,
      isEdit:false,
      page: 1,
      if_filter: false,
      perPage: 8,
      whichPage: 1,
      total:20,
      posts:[]
    }
  },
  methods:{
    submit(flag){
      this.showConfirm = flag
      getMyPost(1,this.perPage)
          .then((res) => {
            console.log(res.data.total)
            this.total = res.data.total;
            this.posts = res.data.myPosts;
            this.loading = false;
          })
          .catch((err) => console.log("error: " + err))
    },
    closeConfirm(flag){
      this.showConfirm = flag
    },
    stepToPost(postId){
      this.$router.push({path: '/post/'+ postId, params:{id:postId}})
    },
    jumpPage() {
      this.page = Number(this.whichPage);
      this.onPageChange(this.page)
    },
    onPageChange(page) {
      this.loading = true;
      getMyPost(page,this.perPage)
          .then((res) => {
            console.log(res.data.total)
            this.total = res.data.total;
            this.posts = res.data.myPosts;
            this.loading = false;
          })
          .catch((err) => console.log("error: " + err));
    },
    deletePost(id){
      this.postId = id
      this.showConfirm = !this.showConfirm
    },

  },
  mounted() {
    this.loading = true;
    getMyPost(1,this.perPage)
        .then((res) => {
          console.log(res.data.total)
          this.total = res.data.total;
          this.posts = res.data.myPosts;
          this.loading = false;
        })
        .catch((err) => console.log("error: " + err))
  },
}
</script>

<style scoped>
.lead{
  margin-top:7px
}
.v-text-field{
  width:45px;
  height:20px;
  margin-left: 8px;
  margin-right: 8px
}
.goBtn{
  margin-left:10px
}
</style>